<form class="application-form" [formGroup]="form">
  <main class="container-fluid py-4">
    <div class="container-xl">
      <section class="card shadow-sm border-0">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="fw-semibold text-primary">
              Temporary Application ID:
              <span class="text-dark">{{ tempApplicationId }}</span>
            </div>

            <div class="d-flex gap-2">
              <button mat-stroked-button color="primary" (click)="saveAndExit()">
                Save & Continue Later
              </button>

              <button mat-stroked-button color="warn" (click)="exitApplication()">Exit</button>
            </div>
          </div>

          <mat-horizontal-stepper linear labelPosition="bottom">
            <!-- STEP 1: APPLICATION TYPE -->
            <mat-step [stepControl]="application">
              <ng-template matStepLabel>Application Type</ng-template>

              <div class="row g-3" formGroupName="application">
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Select Application Type</mat-label>

                    <mat-select formControlName="applicationType">
                      <mat-option value="L1">L1 — Liberian Citizen (Domestic)</mat-option>
                      <mat-option value="L2">L2 — Liberian Citizen (Diaspora)</mat-option>
                      <mat-option value="Y1">Y1 — Youth (12–17)</mat-option>
                      <mat-option value="F1">F1 — Foreign Nationals</mat-option>
                    </mat-select>

                    <mat-error *ngIf="application.controls.applicationType.hasError('required')">
                      Application type is required
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <div class="d-flex justify-content-end mt-3">
                <button mat-button matStepperNext color="primary">Next</button>
              </div>
            </mat-step>

            <!-- STEP 2: PERSONAL INFO -->
            <mat-step [stepControl]="personalInfo">
              <ng-template matStepLabel>Personal Information</ng-template>

              <div class="row g-3" formGroupName="personalInfo">
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Surname</mat-label>
                    <input matInput formControlName="surname" autocomplete="family-name" />
                    <mat-error *ngIf="personalInfo.controls.surname.hasError('required')">
                      Surname is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Given Names</mat-label>
                    <input matInput formControlName="givenNames" autocomplete="given-name" />
                    <mat-error *ngIf="personalInfo.controls.givenNames.hasError('required')">
                      Given names are required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Gender</mat-label>
                    <mat-select formControlName="gender">
                      <mat-option value="Male">Male</mat-option>
                      <mat-option value="Female">Female</mat-option>
                    </mat-select>
                    <mat-error *ngIf="personalInfo.controls.gender.hasError('required')">
                      Gender is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Date of Birth</mat-label>
                    <input
                      matInput
                      [matDatepicker]="dobPicker"
                      formControlName="dateOfBirth"
                      [max]="today"
                    />
                    <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
                    <mat-datepicker #dobPicker startView="multi-year"></mat-datepicker>

                    <mat-error *ngIf="personalInfo.controls.dateOfBirth.hasError('required')">
                      Date of birth is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- phone/email (now exist in TS) -->
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="phone" autocomplete="tel" />
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Email Address</mat-label>
                    <input matInput type="email" formControlName="email" autocomplete="email" />
                    <mat-error *ngIf="personalInfo.controls.email.hasError('email')">
                      Enter a valid email
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext color="primary">Next</button>
              </div>
            </mat-step>

            <!-- STEP 3: PLACE OF BIRTH -->
            <mat-step [stepControl]="placeOfBirth">
              <ng-template matStepLabel>Place of Birth</ng-template>

              <div class="row g-3" formGroupName="placeOfBirth">
                <div class="col-12 col-md-4">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>City</mat-label>
                    <input matInput formControlName="city" />
                    <mat-error *ngIf="placeOfBirth.controls.city.hasError('required')">
                      City is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-4">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>County/State</mat-label>
                    <input matInput formControlName="county" />
                    <mat-error *ngIf="placeOfBirth.controls.county.hasError('required')">
                      County/State is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-4">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Country</mat-label>
                    <mat-select formControlName="country">
                      <mat-option *ngFor="let c of countries; trackBy: trackByCountry" [value]="c">
                        {{ c }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="placeOfBirth.controls.country.hasError('required')">
                      Country is required
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <p class="nirl-info-text">Please choose your County and District. Based on your selection, the system will show the nearest NIRL Enrollment Center serving your location.</p>
              <!-- ADD *ngIf — optional; remove it if you prefer showing disabled fields for L2 -->
              <div class="row g-3" formGroupName="countyOfApplication" *ngIf="!isL2()">
                <!-- County -->
                <div class="col-12 col-md-4">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>County</mat-label>
                    <mat-select formControlName="county">
                      <mat-option *ngFor="let c of counties; trackBy: trackByCounty" [value]="c.id">
                        {{ c.name }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="countyCtrl.touched && countyCtrl.hasError('required')">
                      County is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- District -->
                <div class="col-12 col-md-4">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>District</mat-label>
                    <mat-select formControlName="district">
                      <mat-option
                        *ngFor="let d of filteredDistricts$ | async; trackBy: trackByDistrict"
                        [value]="d.id"
                      >
                        {{ d.name }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="districtCtrl.touched && districtCtrl.hasError('required')">
                      District is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- Application Center -->
                <div class="col-12 col-md-4">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Application Center</mat-label>
                    <mat-select formControlName="center">
                      <mat-option
                        *ngFor="let cn of filteredCenters$ | async; trackBy: trackByCenter"
                        [value]="cn.id"
                      >
                        {{ cn.name }} — {{ cn.address }}
                      </mat-option>
                    </mat-select>
                    <mat-hint>Each center is shown with its unique address.</mat-hint>
                    <mat-error *ngIf="centerCtrl.touched && centerCtrl.hasError('required')">
                      Application center is required
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext color="primary">Next</button>
              </div>
            </mat-step>

            <!-- STEP 4: PASSPORT (L2 ONLY) -->
            <mat-step *ngIf="isL2()" [stepControl]="passportInfo">
              <ng-template matStepLabel>Passport Info</ng-template>

              <div class="row g-3" formGroupName="passportInfo">
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Passport Number</mat-label>
                    <input matInput formControlName="passportNumber" autocomplete="off" />
                    <mat-error *ngIf="passportInfo.controls.passportNumber.hasError('required')">
                      Passport number is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Issue Date</mat-label>
                    <input
                      matInput
                      [matDatepicker]="issuePicker"
                      formControlName="issueDate"
                      [max]="today"
                    />
                    <mat-datepicker-toggle matSuffix [for]="issuePicker"></mat-datepicker-toggle>
                    <mat-datepicker #issuePicker startView="multi-year"></mat-datepicker>

                    <mat-error *ngIf="passportInfo.controls.issueDate.hasError('required')">
                      Issue date is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Expiry Date</mat-label>
                    <input
                      matInput
                      [matDatepicker]="expiryPicker"
                      formControlName="expiryDate"
                      [min]="passportInfo.controls.issueDate.value || null"
                    />
                    <mat-datepicker-toggle matSuffix [for]="expiryPicker"></mat-datepicker-toggle>
                    <mat-datepicker #expiryPicker startView="multi-year"></mat-datepicker>

                    <mat-error *ngIf="passportInfo.controls.expiryDate.hasError('required')">
                      Expiry date is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Issue Place</mat-label>
                    <input matInput formControlName="issuePlace" />
                  </mat-form-field>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext color="primary">Next</button>
              </div>
            </mat-step>

            <!-- STEP 5: GUARDIAN (Y1 ONLY) -->
            <mat-step *ngIf="isY1()" [stepControl]="guardianInfo">
              <ng-template matStepLabel>Guardian Info</ng-template>

              <div class="row g-3" formGroupName="guardianInfo">
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Guardian Full Name</mat-label>
                    <input matInput formControlName="guardianFullName" />
                    <mat-error *ngIf="guardianInfo.controls.guardianFullName.hasError('required')">
                      Guardian name is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-3">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Relationship</mat-label>
                    <input matInput formControlName="relationship" />
                    <mat-error *ngIf="guardianInfo.controls.relationship.hasError('required')">
                      Relationship is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-3">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Guardian Phone</mat-label>
                    <input matInput formControlName="guardianPhone" />
                    <mat-error *ngIf="guardianInfo.controls.guardianPhone.hasError('required')">
                      Phone is required
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext color="primary">Next</button>
              </div>
            </mat-step>

            <!-- STEP 6: FOREIGN DATA COLLECTION (F1 ONLY) -->
            <mat-step *ngIf="isF1()" [stepControl]="foreignInfo">
              <ng-template matStepLabel>Immigration &amp; Residency</ng-template>

              <div class="row g-3" formGroupName="foreignInfo">
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Passport Number</mat-label>
                    <input matInput formControlName="passportNumber" />
                    <mat-error *ngIf="foreignInfo.controls.passportNumber.hasError('required')">
                      Passport number is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Issue Date</mat-label>
                    <input
                      matInput
                      [matDatepicker]="fIssuePicker"
                      formControlName="passportIssueDate"
                      [max]="today"
                    />
                    <mat-datepicker-toggle matSuffix [for]="fIssuePicker"></mat-datepicker-toggle>
                    <mat-datepicker #fIssuePicker startView="multi-year"></mat-datepicker>
                  </mat-form-field>
                </div>
                <!-- Nationality Category -->
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Nationality Category</mat-label>

                    <mat-select formControlName="nationalityCategory">
                      <mat-option value="ECOWAS">ECOWAS (West African Community)</mat-option>
                      <mat-option value="NON_ECOWAS">Non-ECOWAS</mat-option>
                    </mat-select>

                    <mat-error
                      *ngIf="foreignInfo.controls.nationalityCategory.hasError('required')"
                    >
                      Nationality category is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- Nationality -->
                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Nationality</mat-label>

                    <mat-select
                      formControlName="nationality"
                      [disabled]="!foreignInfo.controls.nationalityCategory.value"
                    >
                      <!-- ECOWAS -->
                      <ng-container
                        *ngIf="foreignInfo.controls.nationalityCategory.value === 'ECOWAS'"
                      >
                        <mat-option *ngFor="let c of ecowasCountries" [value]="c">
                          {{ c }}
                        </mat-option>
                      </ng-container>

                      <!-- NON-ECOWAS -->
                      <ng-container
                        *ngIf="foreignInfo.controls.nationalityCategory.value === 'NON_ECOWAS'"
                      >
                        <mat-option *ngFor="let c of nonEcowasCountries" [value]="c">
                          {{ c }}
                        </mat-option>
                      </ng-container>
                    </mat-select>

                    <mat-error *ngIf="foreignInfo.controls.nationality.hasError('required')">
                      Nationality is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Expiry Date</mat-label>
                    <input
                      matInput
                      [matDatepicker]="fExpiryPicker"
                      formControlName="passportExpiryDate"
                      [min]="foreignInfo.controls.passportIssueDate.value || null"
                    />
                    <mat-datepicker-toggle matSuffix [for]="fExpiryPicker"></mat-datepicker-toggle>
                    <mat-datepicker #fExpiryPicker startView="multi-year"></mat-datepicker>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Visa Number</mat-label>
                    <input matInput formControlName="visaNumber" />
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Residence/Work Permit Number</mat-label>
                    <input matInput formControlName="residencePermitNumber" />
                    <mat-error
                      *ngIf="foreignInfo.controls.residencePermitNumber.hasError('required')"
                    >
                      Permit number is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Employer/Institution Name</mat-label>
                    <input matInput formControlName="employerInstitution" />
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Current Address in Liberia</mat-label>
                    <input matInput formControlName="currentAddressLiberia" />
                    <mat-error
                      *ngIf="foreignInfo.controls.currentAddressLiberia.hasError('required')"
                    >
                      Current address in Liberia is required
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Permanent Address (Home Country)</mat-label>
                    <input matInput formControlName="permanentAddressHome" />
                  </mat-form-field>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext color="primary">Next</button>
              </div>
            </mat-step>

            <!-- STEP 7: DOCUMENTS -->
            <mat-step [stepControl]="documents">
              <ng-template matStepLabel>Documents</ng-template>

              <div class="row g-4" formGroupName="documents">
                <!-- Photo -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    PassportSize Photo <span class="text-danger">*</span>
                  </label>
                  <input
                    class="form-control"
                    type="file"
                    accept="image/jpeg,image/png"
                    (change)="onFileChange($event, 'photo')"
                  />

                  <div
                    class="invalid-feedback d-block"
                    *ngIf="
                      documents.controls.photo.invalid &&
                      (documents.controls.photo.touched || documents.controls.photo.dirty)
                    "
                  >
                    <ng-container *ngIf="documents.controls.photo.hasError('required')">
                      Photo is required.
                    </ng-container>
                    <ng-container *ngIf="documents.controls.photo.hasError('fileType')">
                      Allowed types: JPG, PNG.
                    </ng-container>
                    <ng-container *ngIf="documents.controls.photo.hasError('maxSize')">
                      Max size: 2MB.
                    </ng-container>
                  </div>
                </div>

                <!-- L1/Y1 Birth Certificate -->
                <ng-container *ngIf="!isL2() && !isF1()">
                  <div class="col-12">
                    <label class="form-label fw-semibold">
                      Birth Certificate <span class="text-danger">*</span>
                    </label>
                    <input
                      class="form-control"
                      type="file"
                      accept="application/pdf,image/jpeg,image/png"
                      (change)="onFileChange($event, 'birthCertificate')"
                    />
                  </div>
                </ng-container>

                <!-- L2 Documents -->
                <ng-container *ngIf="isL2()">
                  <div class="col-12">
                    <label class="form-label fw-semibold">
                      Passport Copy <span class="text-danger">*</span>
                    </label>
                    <input
                      class="form-control"
                      type="file"
                      accept="application/pdf,image/jpeg,image/png"
                      (change)="onFileChange($event, 'passportCopy')"
                    />
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-semibold">
                      Address Proof <span class="text-danger">*</span>
                    </label>
                    <input
                      class="form-control"
                      type="file"
                      accept="application/pdf"
                      (change)="onFileChange($event, 'addressProof')"
                    />
                  </div>
                </ng-container>

                <!-- F1 Documents -->
                <ng-container *ngIf="isF1()">
                  <div class="col-12">
                    <label class="form-label fw-semibold">
                      Passport Copy <span class="text-danger">*</span>
                    </label>
                    <input
                      class="form-control"
                      type="file"
                      accept="application/pdf,image/jpeg,image/png"
                      (change)="onFileChange($event, 'passportCopy')"
                    />
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-semibold">
                      Permit/Residence Proof <span class="text-danger">*</span>
                    </label>
                    <input
                      class="form-control"
                      type="file"
                      accept="application/pdf,image/jpeg,image/png"
                      (change)="onFileChange($event, 'permitProof')"
                    />
                  </div>
                </ng-container>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext color="primary">Review</button>
              </div>
            </mat-step>

            <!-- STEP 8: REVIEW -->
            <mat-step>
              <ng-template matStepLabel>Review &amp; Submit</ng-template>

              <div class="card bg-light border-0">
                <div class="card-body">
                  <h3 class="h5 mb-3">Summary</h3>
                  <pre class="small bg-white p-3 rounded border">{{ form.value | json }}</pre>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-raised-button color="primary" (click)="submit()">
                  Submit Application
                </button>
              </div>
            </mat-step>
          </mat-horizontal-stepper>
        </div>
      </section>
    </div>
  </main>
</form>
